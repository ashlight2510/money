// ë‚´ ìžì‚° ë°©íƒ„ ì§€ìˆ˜ í…ŒìŠ¤íŠ¸ - ë©”ì¸ ë¡œì§ (ë‹¤êµ­ì–´ ì§€ì›)

const languagePacks = {
  ko: {
    metaTitle: "ë‚´ ìžì‚° ë°©íƒ„ ì§€ìˆ˜ í…ŒìŠ¤íŠ¸",
    heroTitle: "ðŸ›¡ï¸ ë‚´ ìžì‚° ë°©íƒ„ ì§€ìˆ˜ í…ŒìŠ¤íŠ¸",
    heroSubtitle: "ê²½ì œìœ„ê¸° ì™€ë„ ë‚´ ìžì‚°ì€ ì–¼ë§ˆë‚˜ ë²„í‹¸ê¹Œ?",
    heroDescription: "10ë¬¸í•­ìœ¼ë¡œ ì•Œì•„ë³´ëŠ” ë‚˜ì˜ ìžì‚° ë°©ì–´ë ¥",
    shareHint: "ë§í¬ë¥¼ ë³µì‚¬í•´ ì¹œêµ¬ì—ê²Œ ê³µìœ í•´ë³´ì„¸ìš”.",
    loadingText: "ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³  ìžˆìŠµë‹ˆë‹¤...",
    alertNeedTest: "ì¹´ë“œë¥¼ ë‹¤ ì±„ìš´ ë’¤ ê²°ê³¼ë¥¼ ë³´ì„¸ìš”.",
    shareLinkCopied: "ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!",
    resultHeading: "ðŸ›¡ï¸ ë‚˜ì˜ ìžì‚° ë°©íƒ„ ì§€ìˆ˜",
    resultSubtitle: "í…ŒìŠ¤íŠ¸ ê²°ê³¼",
    chartLabels: {
      defense: "ðŸ›¡ï¸ ë°©ì–´ë ¥ (Defense)",
      risk: "âš ï¸ ìœ„í—˜ ë…¸ì¶œ (Risk)",
      fundamentals: "ðŸ’ª ê¸°ì´ˆ ì²´ë ¥ (Fundamentals)",
    },
    guideTitle: "ðŸ“š ìžì‚° ê´€ë¦¬ ê¸°ë³¸ ê°€ì´ë“œ",
    guideItems: [
      {
        title: "1. ë¹„ìƒê¸ˆ í™•ë³´",
        body: "ì›” ì§€ì¶œì˜ 3~6ê°œì›”ì¹˜ ê¸ˆì•¡ì„ í˜„ê¸ˆ/ë‹¨ê¸°ì˜ˆê¸ˆìœ¼ë¡œ ê°–ì¶° ë‘ë©´ ì¶©ê²©ì„ ë²„í‹¸ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.",
      },
      {
        title: "2. 70/20/10 ìžì‚° ë¹„ìœ¨",
        body: "ì£¼ì‹í˜• ìžì‚° 70%, ì±„ê¶Œ/ì•ˆì „ìžì‚° 20%, í˜„ê¸ˆ 10% ì •ë„ë¡œ ê· í˜•ì„ ìœ ì§€í•˜ì„¸ìš”.",
      },
      {
        title: "3. ETF ì¤‘ì‹¬ ìž¥ê¸° íˆ¬ìž",
        body: "ì§€ìˆ˜ë¥¼ ë”°ë¼ê°€ëŠ” ETFë¥¼ ê¾¸ì¤€ížˆ ì ë¦½í•´ ë³€ë™ì„±ì„ ë¶„ì‚°í•˜ì„¸ìš”.",
      },
      {
        title: "4. ë³´í—˜ìœ¼ë¡œ ìœ„í—˜ ëŒ€ë¹„",
        body: "ê±´ê°•Â·ìƒí•´ ë³´í—˜ì„ ê¸°ë³¸ìœ¼ë¡œ ê°–ì¶”ê³ , í•„ìš” ì‹œ ê°€ì¡±ë ¥ ê¸°ë°˜ìœ¼ë¡œ í™•ìž¥í•˜ì„¸ìš”.",
      },
      {
        title: "5. ì„¸ê¸ˆ í˜œíƒ í™œìš©",
        body: "IRP/ì—°ê¸ˆì €ì¶• ë“± ì„¸ê¸ˆ ìš°ëŒ€ ìƒí’ˆì„ í¬í•¨í•´ ìž¥ê¸° ì €ì¶•ì„ ì„¤ê³„í•˜ì„¸ìš”.",
      },
    ],
    shareLinkButton: "ë§í¬ ë³µì‚¬",
    restartButton: "ë‹¤ì‹œ í…ŒìŠ¤íŠ¸í•˜ê¸°",
    shareMessage: "ë‚´ ìžì‚° ë°©íƒ„ ì§€ìˆ˜ í…ŒìŠ¤íŠ¸: https://money.funnyfunny.cloud/",
    copyAlert: "ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!",
    moreTestsButton: "ë” ë§Žì€ í…ŒìŠ¤íŠ¸ í•´ë³´ê¸°",
    scoreLabel: "ì ",
  },
  en: {
    metaTitle: "Asset Shield Index Test",
    heroTitle: "ðŸ›¡ï¸ Asset Shield Index Test",
    heroSubtitle: "How would your money survive a crisis?",
    heroDescription: "10 quick questions that measure your financial defenses.",
    shareHint: "Copy the link to share your result.",
    loadingText: "Analyzing your result...",
    alertNeedTest: "Please finish the quiz before viewing the result.",
    shareLinkCopied: "Link copied to clipboard!",
    resultHeading: "ðŸ›¡ï¸ Asset Shield Index",
    resultSubtitle: "Your test result",
    chartLabels: {
      defense: "ðŸ›¡ï¸ Defense",
      risk: "âš ï¸ Risk exposure",
      fundamentals: "ðŸ’ª Fundamentals",
    },
    guideTitle: "ðŸ“š Financial guardrails",
    guideItems: [
      {
        title: "1. Build an emergency fund",
        body: "Save 3â€“6 months of your expenses in liquid accounts for sudden shocks.",
      },
      {
        title: "2. Keep a 70/20/10 split",
        body: "Aim for 70% growth assets, 20% stable income, 10% cash for flexibility.",
      },
      {
        title: "3. Stay ETF-focused",
        body: "Regularly invest in low-fee ETFs to smooth volatility over time.",
      },
      {
        title: "4. Cover risks with insurance",
        body: "Maintain health/accident policies and adjust coverage as life changes.",
      },
      {
        title: "5. Use tax-advantaged accounts",
        body: "Include IRP, pension savings, or retirement accounts in your savings plan.",
      },
    ],
    shareLinkButton: "Copy link",
    restartButton: "Restart test",
    shareMessage: "Check my score: https://money.funnyfunny.cloud/",
    copyAlert: "Link copied to clipboard!",
    moreTestsButton: "Try more tests",
    scoreLabel: "points",
  },
};

const resultLocales = {
  balanced: {
    ko: {
      typeName: "í˜„ì‹¤í˜• ë°¸ëŸ°ìŠ¤ íˆ¬ìžìž",
      typeDescription: "ì•ˆì •ì„±ê³¼ ìˆ˜ìµì„±ì„ ê· í˜• ìžˆê²Œ ì±™ê¸°ë©° ëƒ‰ì •í•˜ê²Œ íŒë‹¨í•˜ëŠ” ìŠ¤íƒ€ì¼ìž…ë‹ˆë‹¤.",
      typeAdvice: [
        "ETF ì¤‘ì‹¬ ìž¥ê¸° íˆ¬ìžë¥¼ ê¾¸ì¤€ížˆ ì´ì–´ê°€ì„¸ìš”.",
        "ë¹„ìƒê¸ˆì€ ì›” ì§€ì¶œì˜ 3~6ê°œì›”ì¹˜ë¥¼ ìœ ì§€í•˜ì„¸ìš”.",
        "IRP/ì—°ê¸ˆì €ì¶•ìœ¼ë¡œ ì„¸ê¸ˆ í˜œíƒì„ ì±™ê¸°ì„¸ìš”.",
        "ìžì‚°ì„ ì£¼ì‹Â·ì±„ê¶ŒÂ·í˜„ê¸ˆìœ¼ë¡œ ë¶„ì‚°í•˜ì„¸ìš”.",
      ],
    },
    en: {
      typeName: "Balanced realist",
      typeDescription: "You blend safety and returns, keeping a clear head during volatility.",
      typeAdvice: [
        "Continue regular investments into diversified ETFs.",
        "Keep 3â€“6 months of expenses as emergency cash.",
        "Use tax-advantaged IRP/pension accounts when possible.",
        "Distribute assets across equities, bonds, and cash.",
      ],
    },
  },
  defense: {
    ko: {
      typeName: "ê³µí¬í˜• ë””íŽœìŠ¤ íˆ¬ìžìž",
      typeDescription: "ë¦¬ìŠ¤í¬ íšŒí”¼ ì„±í–¥ì´ ê°•í•˜ë©° ì•ˆì „ì„±ì„ ìµœìš°ì„ ìœ¼ë¡œ í•©ë‹ˆë‹¤.",
      typeAdvice: [
        "í˜„ê¸ˆ ë¹„ì¤‘ì´ ë†’ì„ìˆ˜ë¡ ì¸í”Œë ˆì´ì…˜ ìœ„í—˜ì— ëŒ€ë¹„í•˜ì„¸ìš”.",
        "ì£¼ì‹ ë¹„ì¤‘ì„ ì¡°ê¸ˆì”© ëŠ˜ë¦¬ë©° ì„±ìž¥ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ êµ¬ì¶•í•˜ì„¸ìš”.",
        "ê¸ˆÂ·ì±„ê¶Œ ë“± ë‹¤ë¥¸ ìžì‚°ìœ¼ë¡œ ë°©ì–´ë§‰ì„ í™•ìž¥í•˜ì„¸ìš”.",
        "ìž¥ê¸° ê´€ì ì—ì„œ ë¦¬ìŠ¤í¬ë¥¼ ê´€ë¦¬í•˜ë©° ê¸°íšŒë¥¼ ê¸°ë‹¤ë¦¬ì„¸ìš”.",
      ],
    },
    en: {
      typeName: "Fearful defender",
      typeDescription: "You prioritize safety even when opportunity knocks.",
      typeAdvice: [
        "Too much cash can lose valueâ€”consider adding low-volatility equities.",
        "Build a mix of bonds, gold, and cash to spread risk.",
        "Gradually grow your stock exposure while keeping hedges.",
        "Stay patient and let the long-term trend work for you.",
      ],
    },
  },
  risk: {
    ko: {
      typeName: "ê³µê²©í˜• ë¦¬ìŠ¤í¬ í…Œì´ì»¤",
      typeDescription: "ë†’ì€ ìˆ˜ìµì„ ë…¸ë¦¬ë©° ë¦¬ìŠ¤í¬ ë…¸ì¶œì´ í° ìŠ¤íƒ€ì¼ìž…ë‹ˆë‹¤.",
      typeAdvice: [
        "ë¹„ìƒê¸ˆì„ ë¨¼ì € í™•ë³´í•œ ë’¤ ê³ ìœ„í—˜ ìžì‚°ì„ ì¡°ì ˆí•˜ì„¸ìš”.",
        "ë³´í—˜(ê±´ê°•/ìƒí•´)ì„ í†µí•´ ê¸‰ë³€ ìƒí™©ì„ ëŒ€ë¹„í•˜ì„¸ìš”.",
        "ì „ì²´ ìžì‚°ì˜ 30% ì´ìƒì„ ê³ ìœ„í—˜ìœ¼ë¡œ ë‘ì§€ ë§ˆì„¸ìš”.",
        "ë¶„ì‚° íˆ¬ìžë¥¼ ìœ ì§€í•˜ë©° ë³€ë™ì„±ì„ ê´€ë¦¬í•˜ì„¸ìš”.",
      ],
    },
    en: {
      typeName: "Aggressive risk taker",
      typeDescription: "You seek high returns, often moving fast through volatile markets.",
      typeAdvice: [
        "Lock in 3â€“6 months of emergency cash before chasing high risk.",
        "Hedge sudden shocks with health or accident cover.",
        "Limit high-risk positions to around 30% of your portfolio.",
        "Stay diversified to temper volatility while keeping growth assets.",
      ],
    },
  },
};

let currentLang = "ko";
let currentQuestionIndex = 0;
let answers = {};
let scores = { defense: 0, risk: 0, fundamentals: 0 };
let questionScores = {};
let lastResultData = null;

function getPack() {
  return languagePacks[currentLang] || languagePacks.ko;
}

function t(key, vars = {}) {
  const pack = getPack();
  const template = pack[key] ?? languagePacks.ko[key] ?? key;
  if (typeof template !== "string") return template;
  return template.replace(/\{(\w+)\}/g, (_, token) =>
    vars[token] !== undefined ? vars[token] : `{${token}}`
  );
}

function detectLang() {
  const urlParams = new URLSearchParams(window.location.search);
  const param = urlParams.get("lang");
  if (param && languagePacks[param]) return param;
  const stored = localStorage.getItem("preferredLang");
  if (stored && languagePacks[stored]) return stored;
  const intlLocale =
    typeof Intl === "object" && typeof Intl.DateTimeFormat === "function"
      ? Intl.DateTimeFormat().resolvedOptions().locale
      : "";
  const browserLang =
    navigator.languages && navigator.languages.length
      ? navigator.languages[0]
      : navigator.language;
  if (browserLang && browserLang.toLowerCase().startsWith("ko")) {
    return "ko";
  }
  return defaultLang;
}

function applyTranslations() {
  document.title = t("metaTitle");
  document.body.classList.toggle("lang-en", currentLang === "en");
  document.querySelectorAll("[data-i18n]").forEach((el) => {
    const key = el.dataset.i18n;
    if (key) el.textContent = t(key);
  });
  document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
    const key = el.dataset.i18nPlaceholder;
    if (key) el.setAttribute("placeholder", t(key));
  });
}

function setLang(lang, options = {}) {
  const nextLang = languagePacks[lang] ? lang : "ko";
  currentLang = nextLang;
  document.documentElement.lang = nextLang;
  localStorage.setItem("preferredLang", nextLang);
  document
    .querySelectorAll(".lang-switch button")
    .forEach((button) =>
      button.classList.toggle("active", button.dataset.lang === nextLang)
    );
  applyTranslations();
  if (!options.skipRender) {
    if (document.getElementById("questionContainer")) {
      loadQuestion();
    } else if (lastResultData) {
      displayResult(lastResultData);
    }
  }
  if (options.updateUrl) {
    const url = new URL(window.location.href);
    url.searchParams.set("lang", nextLang);
    window.history.replaceState({}, "", url);
  }
}

function getQuestionSet() {
  return questions[currentLang] || questions.ko;
}

function initLanguageSwitcher() {
  document.querySelectorAll(".lang-switch button").forEach((button) => {
    button.addEventListener("click", () => {
      setLang(button.dataset.lang, { updateUrl: true });
    });
  });
}

function initPage() {
  if (
    window.location.pathname.includes("result.html") ||
    window.location.href.includes("result.html")
  ) {
    loadResult();
  } else {
    loadQuestion();
  }
}

function loadQuestion() {
  const dataset = getQuestionSet();
  const container = document.getElementById("questionContainer");
  if (!container) return;
  const question = dataset[currentQuestionIndex];
  if (!question) {
    calculateResult();
    return;
  }
  const progress = ((currentQuestionIndex + 1) / dataset.length) * 100;
  document.getElementById("progressFill").style.width = `${progress}%`;

  let html = `
    <div class="question-card">
      <h2>${question.title}</h2>
      ${question.subtitle ? `<p class="subtitle">${question.subtitle}</p>` : ""}
      <div class="choices">
  `;

  question.choices.forEach((choice, index) => {
    const choiceId = `choice-${currentQuestionIndex}-${index}`;
    html += `
      <div class="choice-item" 
           onclick="selectChoice(${index}, '${choiceId}')" 
           id="${choiceId}">
        ${choice.label}
      </div>
    `;
  });

  html += `
      </div>
    </div>
  `;

  container.innerHTML = html;

  if (answers[question.id] !== undefined) {
    const prevChoiceId = `choice-${currentQuestionIndex}-${answers[question.id]}`;
    const el = document.getElementById(prevChoiceId);
    if (el) el.classList.add("selected");
  }
}

function selectChoice(index, choiceId) {
  const dataset = getQuestionSet();
  const question = dataset[currentQuestionIndex];
  if (!question) return;
  question.choices.forEach((_, i) => {
    const id = `choice-${currentQuestionIndex}-${i}`;
    document.getElementById(id)?.classList.remove("selected");
  });
  document.getElementById(choiceId)?.classList.add("selected");

  if (questionScores[question.id]) {
    const prev = questionScores[question.id];
    scores.defense -= prev.defense || 0;
    scores.risk -= prev.risk || 0;
    scores.fundamentals -= prev.fundamentals || 0;
  }

  answers[question.id] = index;
  const selectedChoice = question.choices[index];
  const newScore = {
    defense: selectedChoice.value.defense || 0,
    risk: selectedChoice.value.risk || 0,
    fundamentals: selectedChoice.value.fundamentals || 0,
  };
  questionScores[question.id] = newScore;
  scores.defense += newScore.defense;
  scores.risk += newScore.risk;
  scores.fundamentals += newScore.fundamentals;

  setTimeout(() => {
    handleNext();
  }, 400);
}

function handleNext() {
  currentQuestionIndex++;
  const dataset = getQuestionSet();
  if (currentQuestionIndex >= dataset.length) {
    calculateResult();
  } else {
    loadQuestion();
  }
}

function calculateResult() {
  const defenseScore = Math.min(100, Math.max(0, scores.defense));
  const fundamentalsScore = Math.min(100, Math.max(0, scores.fundamentals));
  const riskScore = Math.min(100, Math.max(0, scores.risk));
  const shieldScore = Math.round(
    defenseScore * 0.45 +
      fundamentalsScore * 0.35 +
      (100 - riskScore) * 0.2
  );

  let resultType = "balanced";
  if (defenseScore > 50 && riskScore < 30) {
    resultType = "defense";
  } else if (riskScore > 40 || (defenseScore < 30 && fundamentalsScore < 30)) {
    resultType = "risk";
  }

  const locale =
    resultLocales[resultType][currentLang] ||
    resultLocales[resultType]["ko"];

  const resultData = {
    shieldScore: shieldScore,
    defenseScore,
    riskScore,
    fundamentalsScore,
    resultType,
    typeName: locale.typeName,
    typeDescription: locale.typeDescription,
    typeAdvice: locale.typeAdvice,
  };

  try {
    localStorage.setItem("testResult", JSON.stringify(resultData));
    window.location.href = "result.html";
  } catch (error) {
    const encoded = encodeURIComponent(JSON.stringify(resultData));
    window.location.href = `result.html?data=${encoded}`;
  }
}

function loadResult() {
  let resultData = null;
  try {
    const stored = localStorage.getItem("testResult");
    if (stored) {
      resultData = JSON.parse(stored);
      localStorage.removeItem("testResult");
    }
  } catch (error) {
    console.error(error);
  }

  if (!resultData) {
    const params = new URLSearchParams(window.location.search);
    const encoded = params.get("data");
    if (encoded) {
      try {
        resultData = JSON.parse(decodeURIComponent(encoded));
      } catch (error) {
        console.error(error);
      }
    }
  }

  if (!resultData) {
    alert(t("alertNeedTest"));
    window.location.href = "index.html";
    return;
  }

  lastResultData = resultData;
  displayResult(resultData);
}

function displayResult(data) {
  lastResultData = data;
  const container = document.querySelector(".container") || document.body;
  const pack = getPack();

  const guideHtml = pack.guideItems
    .map(
      (item) => `
      <div class="guide-item">
        <h4>${item.title}</h4>
        <p>${item.body}</p>
      </div>
    `
    )
    .join("");

  container.innerHTML = `
    <div class="result-container">
      <div class="header">
        <h1>${pack.resultHeading}</h1>
        <p class="subtitle">${pack.resultSubtitle}</p>
      </div>
      <div class="score-circle">
        <div>
          <div class="score-value">${data.shieldScore}</div>
          <div class="score-label">${pack.scoreLabel}</div>
        </div>
      </div>
      <div class="result-type">
        <h2>${data.typeName}</h2>
        <p class="description">${data.typeDescription}</p>
        <div class="advice-section">
          <h3>${pack.guideTitle}</h3>
          <div class="guide-grid">${guideHtml}</div>
        </div>
      </div>
      <div class="chart-container">
        <h3 style="margin-bottom: 20px; text-align: center;">${pack.chartLabels.defense}</h3>
        <div class="chart-item">
          <div class="chart-label">
            <span>${pack.chartLabels.defense}</span>
            <span>${Math.round(data.defenseScore)}${pack.scoreLabel}</span>
          </div>
          <div class="chart-bar">
            <div class="chart-fill defense" style="width: ${data.defenseScore}%">
              ${Math.round(data.defenseScore)}%
            </div>
          </div>
        </div>
        <div class="chart-item">
          <div class="chart-label">
            <span>${pack.chartLabels.risk}</span>
            <span>${Math.round(data.riskScore)}${pack.scoreLabel}</span>
          </div>
          <div class="chart-bar">
            <div class="chart-fill risk" style="width: ${data.riskScore}%">
              ${Math.round(data.riskScore)}%
            </div>
          </div>
        </div>
        <div class="chart-item">
          <div class="chart-label">
            <span>${pack.chartLabels.fundamentals}</span>
            <span>${Math.round(data.fundamentalsScore)}${pack.scoreLabel}</span>
          </div>
          <div class="chart-bar">
            <div class="chart-fill fundamentals" style="width: ${data.fundamentalsScore}%">
              ${Math.round(data.fundamentalsScore)}%
            </div>
          </div>
        </div>
      </div>
      <div class="share-buttons">
        <button class="share-btn" onclick="shareLink()">
          ${pack.shareLinkButton}
        </button>
        <button class="share-btn more-tests-btn" onclick="window.open('https://funnyfunny.cloud/', '_blank', 'noopener')">
          ${pack.moreTestsButton}
        </button>
      </div>
      <button class="btn restart-btn" onclick="restartTest()">
        ${pack.restartButton}
      </button>
    </div>
  `;

  applyTranslations();

  setTimeout(() => {
    const fills = container.querySelectorAll(".chart-fill");
    fills.forEach((fill) => {
      const width = fill.style.width;
      fill.style.width = "0%";
      setTimeout(() => {
        fill.style.width = width;
      }, 100);
    });
  }, 500);
}

function shareLink() {
  const message = getPack().shareMessage;
  navigator.clipboard
    .writeText(message)
    .then(() => {
      alert(t("shareLinkCopied"));
    })
    .catch(() => {
      const textarea = document.createElement("textarea");
      textarea.value = message;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand("copy");
      document.body.removeChild(textarea);
      alert(t("shareLinkCopied"));
    });
}

function restartTest() {
  currentQuestionIndex = 0;
  answers = {};
  scores = { defense: 0, risk: 0, fundamentals: 0 };
  questionScores = {};
  lastResultData = null;
  try {
    localStorage.removeItem("testResult");
  } catch (error) {
    console.warn(error);
  }
  window.location.href = "index.html";
}

document.addEventListener("DOMContentLoaded", () => {
  initLanguageSwitcher();
  setLang(detectLang(), { updateUrl: false, skipRender: true });
  initPage();
});
